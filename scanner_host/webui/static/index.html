<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scanner Host Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 32px; background: #f5f6fa; }
    h1 { margin-bottom: 0; }
    .card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 16px; }
    .devices li { margin-bottom: 4px; }
    button { padding: 8px 12px; margin-right: 8px; }
    code { background: #eee; padding: 2px 4px; border-radius: 4px; }
    .status-ok { color: green; font-weight: bold; }
    .status-bad { color: #c00; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Scanner Host</h1>
  <p id="subtitle">Loading...</p>

  <div class="card">
    <h2>Status</h2>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>Pairing</h2>
    <button id="startPairing">Start pairing</button>
    <p>Current code: <strong id="pairCode">(none)</strong></p>
    <p id="pairingExpires"></p>
  </div>

  <div class="card">
    <h2>Connected phones</h2>
    <p id="connectedCount">0 devices</p>
    <ul id="devices" class="devices"></ul>
  </div>

  <div class="card">
    <h2>Actions</h2>
    <button id="pingTest">Ping localhost</button>
    <p id="pingResult">Run a ping from a paired phone to see results here.</p>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const subtitle = document.getElementById('subtitle');
    const pairCode = document.getElementById('pairCode');
    const pairingExpires = document.getElementById('pairingExpires');
    const connectedCount = document.getElementById('connectedCount');
    const devicesEl = document.getElementById('devices');
    const pingResult = document.getElementById('pingResult');
    let statusTimer = null;

    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function refreshStatus() {
      try {
        const data = await fetchJSON('/status');
        subtitle.textContent = `${data.service_instance} (${data.hostname})`;
        statusEl.innerHTML = `Version <code>${data.version}</code> — IP <code>${data.ip}:${data.api_port}</code> — Capabilities: <code>${data.capabilities.join(', ')}</code>`;
        connectedCount.textContent = `${data.connected} device${data.connected === 1 ? '' : 's'} online`;
        devicesEl.innerHTML = '';
        data.devices.forEach(d => {
          const li = document.createElement('li');
          const last = new Date(d.last_seen * 1000).toLocaleTimeString();
          li.textContent = `${d.device_name} (${d.device_id}) — ${d.online ? 'online' : 'offline'} — last seen ${last}`;
          devicesEl.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        subtitle.textContent = 'Host offline';
        statusEl.textContent = 'Waiting for host...';
      }
    }

    async function refreshPairCode() {
      try {
        const data = await fetchJSON('/pair/code');
        pairCode.textContent = data.code;
        pairingExpires.textContent = `Expires in ${(data.expires_in || 0).toFixed(0)}s`;
      } catch (err) {
        pairCode.textContent = '(none)';
        pairingExpires.textContent = '';
      }
    }

    document.getElementById('startPairing').addEventListener('click', async () => {
      try {
        await fetchJSON('/pair/start', { method: 'POST' });
        refreshPairCode();
      } catch (err) {
        alert('Could not start pairing: ' + err.message);
      }
    });

    document.getElementById('pingTest').addEventListener('click', () => {
      pingResult.textContent = 'Ping results will appear when a paired device triggers a ping.';
    });

    refreshStatus();
    refreshPairCode();
    statusTimer = setInterval(() => {
      refreshStatus();
      refreshPairCode();
    }, 8000);
  </script>
</body>
</html>
